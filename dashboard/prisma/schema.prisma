generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Seller {
  phoneNumber  String    @id @map("phone_number") @db.VarChar(20)
  name         String?
  city         String?
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  catalogueUrl String?   @map("catalogue_url")
  products     Product[] @relation("SellerProducts")
  scanLogs     ScanLog[] @relation("SellerScanLogs")

  @@map("sellers")
}

model Product {
  id             String           @id
  sellerPhone    String           @map("seller_phone") @db.VarChar(20)
  rawName        String?          @map("raw_name")
  rawDescription String?          @map("raw_description")
  currency       String?          @db.VarChar(10)
  availability   String?
  imageCount     Int?             @map("image_count")
  modelName      String?          @map("model_name")
  storageGb      String?          @map("storage_gb")
  color          String?
  warranty       String?
  dataHash       String?          @map("data_hash")
  isActive       Boolean          @default(true) @map("is_active")
  firstSeenAt    DateTime         @default(now()) @map("first_seen_at")
  lastSeenAt     DateTime         @default(now()) @map("last_seen_at")
  lastModifiedAt DateTime?        @map("last_modified_at")
  priceRaw       Decimal?         @map("price_raw") @db.Decimal(12, 2)
  batteryHealth  String?          @map("battery_health")
  condition      String?
  historyEntries ProductHistory[]
  seller         Seller           @relation("SellerProducts", fields: [sellerPhone], references: [phoneNumber])

  @@index([sellerPhone])
  @@index([sellerPhone, isActive])
  @@index([lastModifiedAt])
  @@map("products")
}

model ProductHistory {
  historyId  Int      @id @default(autoincrement()) @map("history_id")
  productId  String   @map("product_id")
  recordedAt DateTime @default(now()) @map("recorded_at")
  changeType String   @map("change_type") @db.VarChar(20)
  snapshot   Json     @map("snapshot")
  product    Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@map("product_history")
}

model ScanLog {
  id              Int      @id @default(autoincrement())
  sellerPhone     String   @map("seller_phone") @db.VarChar(20)
  scanTime        DateTime @default(now()) @map("scan_time")
  productsFound   Int      @map("products_found")
  productsNew     Int      @map("products_new")
  productsUpdated Int      @map("products_updated")
  seller          Seller   @relation("SellerScanLogs", fields: [sellerPhone], references: [phoneNumber])

  @@index([sellerPhone, scanTime])
  @@map("scan_logs")
}

model ScraperRun {
  id               Int       @id @default(autoincrement())
  startedAt        DateTime  @default(now()) @map("started_at")
  completedAt      DateTime? @map("completed_at")
  status           String    @db.VarChar(20)
  triggerType      String    @map("trigger_type") @db.VarChar(20)
  output           String?
  errorMessage     String?   @map("error_message")
  sellersProcessed Int       @default(0) @map("sellers_processed")
  productsScraped  Int       @default(0) @map("products_scraped")

  @@index([startedAt])
  @@index([status])
  @@map("scraper_runs")
}

model SchedulerConfig {
  id        Int      @id @default(1)
  enabled   Boolean  @default(false)
  cronExpr  String   @default("0 9,21 * * *") @map("cron_expr") @db.VarChar(50)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("scheduler_config")
}

model SavedView {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(100)
  description String?
  filters     Json     @default("{}")
  columns     String[] @default([])
  sortKey     String?  @map("sort_key") @db.VarChar(50)
  sortDir     String?  @map("sort_dir") @db.VarChar(10)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  columnOrder String[] @default([]) @map("column_order")

  @@index([isDefault])
  @@map("saved_views")
}
